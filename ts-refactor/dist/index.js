import{a as s,b as c,c as w}from"./chunk-ML7ORK23.js";import{readFile as T,stat as M}from"node:fs/promises";import{extname as $,join as L,dirname as N}from"node:path";import{fileURLToPath as R}from"node:url";import{inspect as z}from"node:util";import{Worker as j}from"node:worker_threads";import V from"node:events";import W from"auto-bind";import{z as C}from"zod";var n=C;function I(p,t,e){let r=p.safeParse(t);return r.success===!0?r:{success:!1,errors:r.error.issues.map(o=>`${[e,...o.path].join(".")}\uFF1A${o.message}`)}}s(I,"wrapZodError");import u from"chalk";function h(){}s(h,"noop");var i=class{static makeContent(t=this.prefix,e){return(typeof e=="string"?e.split(`
`):e).map(o=>`${t}${o}`).join(`
`)}config;debug;info;saveLog;log=[];constructor({logToConsole:t,saveLog:e,debugLog:r,detailedError:o}=y.parse({})){this.config={logToConsole:t,saveLog:e,debugLog:r,detailedError:o},t?(this.config.debugLog?this.debug=(l,m)=>{console.log(i.makeContent(`${i.prefix}Debug ${i.levelToStrMap[l]}`,m))}:this.debug=h,this.info=l=>{console.log(l)}):(this.debug=h,this.info=h),this.config.saveLog&&(this.saveLog=l=>{this.log.push(l)})}error(t,e,r=!0){console.error(i.makeContent(`${i.prefix}${t} ${i.errorPrefix}`,e)),r&&process.exit(1)}errors(t,e,r=!0){console.error(i.makeContent(`${i.prefix}${t} ${i.errorPrefix}`,[...e.map((o,l)=>`${l} ${o}`),"\u7531\u65BC\u4E0A\u8FF0\u932F\u8AA4\uFF0C\u5C07\u81EA\u52D5\u9000\u51FA\u7A0B\u5F0F"])),r&&process.exit(1)}runtimeError(t){this.error("Runtime",t,!1)}},a=i;s(a,"Logger"),c(a,"prefix",u.blue("LCL ")),c(a,"errorPrefix",u.red("ERR ")),c(a,"levelToStrMap",{["analyze"]:u.blue("ANALYZE"),["error"]:u.red("ERR"),["exit"]:u.green("EXIT"),["info"]:u.blue("INFO"),["warn"]:u.yellow("WARN")});var y=n.object({logToConsole:n.boolean().default(!0),saveLog:n.boolean().default(!1),debugLog:n.boolean().default(!1),detailedError:n.boolean().default(!1)}).partial();var x="ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz12345678901234567890";function k(p,t){return Math.floor(Math.random()*t)+p}s(k,"randomIntInRange");function S(p){return" ".repeat(p).split("").map(()=>x[k(0,x.length)]).join()}s(S,"notExclusiveRandomId");function v(p,t){let e;do e=S(p);while(t.includes(e));return e}s(v,"randomId");var A=N(R(import.meta.url)),d=class{constructor(t,e){this.instance=e;Object.defineProperty(this,"id",{value:t,writable:!1,configurable:!1}),this.run=this.instance.run}static async create(t,e={}){let{id:r,instance:o}=await f.create(t,e);return new d(r,o)}id;run;on(t,e){this.instance.listener.on(t,e)}};s(d,"Interpreter");var b=class{constructor(t,e,r,o){this.mainFilePath=t;this.content=e;this.config=r;this.logger=o;this.listener=new V,this.state={status:"idle"},W(this)}listener;state;static async create(t,e){let r=I(D,e,"config");if(r.success===!1)throw a.prototype.errors("Interpreter Create",r.errors),"";let o=new a(r.data);try{let g;try{g=await M(t)}catch(E){throw new Error(`\u627E\u4E0D\u5230\u6A94\u6848 ${t}`,{cause:E})}if(!g.isFile())throw new Error(`\u627E\u4E0D\u5230\u6A94\u6848 ${t}`);if($(t)!==".lcl")throw new Error("\u6587\u4EF6\u7684\u526F\u6A94\u540D\u5FC5\u9808\u70BA .lcl")}catch(g){o.error("Interpreter Create",z(g))}let l=await T(t,{encoding:"utf-8"}),m=new b(t,l,e,o);return{id:v(5,Object.keys(this.instances)),instance:m}}run(){return new Promise((t,e)=>{if(this.state.status!=="idle")return e(`\u7121\u6CD5\u57F7\u884C\u72C0\u614B\u4E0D\u70BAidle\u7684\u57F7\u884C\u5668(\u72C0\u614B\uFF1A${this.state.status})`);this.state={status:"pending",onComplete:r=>{this.state.worker.off("message",this.listenMessage),r.success===!1?(this.logger.runtimeError("\u57F7\u884C\u6642\u51FA\u73FE\u932F\u8AA4\uFF1A"),this.logger.runtimeError(r.error),e(r.error)):t(r.data)},worker:new j(L(A,"worker.js"),{workerData:{}}).on("message",this.listenMessage)}})}listenMessage(t){switch(t.type){case"stop":{this.state.onComplete(t.data),this.state.worker.postMessage({type:"ack",id:t.id}),this.state={status:"idle"};break}case"event":{let{event:e}=t;switch(e.name){case"stateChange":this.state={...this.state,status:e.value},this.listener.emit("stateChange",e.value)}break}case"debug":{this.logger.debug(t.level,t.content);break}case"log":this.logger.info(t.content)}this.state.status!=="idle"&&this.state.worker.postMessage({type:"ack",id:t.id})}},f=b;s(f,"InternalInterpreter"),c(f,"instances",{});var P=n.object({chunkPerExecution:n.number().positive().finite().default(100),interval:n.number().nonnegative().default(1),maxChunks:n.number().default(1/0),maxCallLength:n.number().positive().default(100),maxVMem:n.number().nonnegative().default(1/0)}).partial(),O=n.object({fsRoot:n.string().default("")}).partial(),D=P.merge(y).merge(O);export{d as Interpreter,w as Status};
